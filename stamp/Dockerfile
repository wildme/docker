FROM node:18.20-alpine3.20 AS react
WORKDIR /tmp/stamp
RUN wget https://github.com/wildme/stamp/tarball/master -O - | tar xz --strip-components=1
RUN npm install --production --silent
RUN npm run build --silent

FROM node:18.20-alpine3.20 AS express
EXPOSE 3000
EXPOSE 3080
WORKDIR /stamp
RUN npm install -g pm2 --silent
RUN wget https://github.com/wildme/server-stamp/tarball/main -O - | tar xz --strip-components=1
RUN npm install --production --silent
COPY --from=react /tmp/stamp/build ./build
COPY ecosystem.config.js ./
ENV NODE_OPTIONS=--tls-min-v1.0
ENV NODE_ENV=production
ENV STAMP_EXPRESS_PORT=3000
ENV STAMP_WEBSOCKET_PORT=3080
ENV STAMP_EXPRESS_STATIC_DIR='build'
ENV STAMP_EXPRESS_UPLOAD_DIR='files'
ENV STAMP_MONGODB='mongodb://<MONGODB_ADDRESS>:27017/stamp'
ENV STAMP_LANG='en-En'
ENV STAMP_MAX_FILESIZE=5000000
ENV STAMP_SESSION_SECRET=<VERY_LONG_STRING>
ENV STAMP_JWT_ACCESS_SECRET=<VERY_LONG_STRING_1>
ENV STAMP_JWT_REFRESH_SECRET=<VERY_LONG_STRING_2>
ENV STAMP_JWT_COOKIE_AGE=28800000
ENV STAMP_JWT_ACCESS_EXP=600
ENV STAMP_JWT_REFRESH_EXP=28800
ENV STAMP_EXPRESS_SMTP_HOST=<SMTP_ADDRESS>
ENV STAMP_EXPRESS_SMTP_PORT=<SMTP_PORT>
ENV STAMP_EXPRESS_SMTP_SECURE=0
ENV STAMP_EXPRESS_SMTP_REJECT_UNAUTH=0
ENV STAMP_EXPRESS_SMTP_FROM=<EMAIL_ADDRESS>
ENV STAMP_EXPRESS_SMTP_USER=<USERNAME>
ENV STAMP_EXPRESS_SMTP_PASS=<PASSWORD>
ENTRYPOINT ["pm2-runtime", "ecosystem.config.js"]
